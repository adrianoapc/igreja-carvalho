name: Docs Guard

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  docs_guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get changed files
        id: changed
        uses: tj-actions/changed-files@v45

      - name: Enforce docs update for touched modules
        shell: bash
        run: |
          set -euo pipefail

          changed="${{ steps.changed.outputs.all_changed_files }}"
          echo "Changed files:"
          echo "$changed" | tr ' ' '\n'

          DOCS_CHANGED=$(echo "$changed" | tr ' ' '\n' | grep -E '^docs/' || true)

          # Mapa de módulos (regex corretos conforme sua estrutura src/pages e src/components)
          declare -A MODULES=(
            [admin]='^(src/pages/admin/|src/components/admin/)'
            [auth]='^(src/pages/auth/|src/components/auth/|src/integrations/supabase/)'
            [cadastro]='^src/pages/cadastro/'
            [cultos]='^(src/pages/cultos/|src/components/cultos/)'
            [dashboard]='^src/components/dashboard/'
            [ensino]='^(src/pages/ensino/|src/components/ensino/)'
            [financas]='^(src/pages/financas/|src/components/financas/)'
            [intercessao]='^src/pages/intercessao/'
            [kids]='^(src/pages/kids/|src/components/kids/)'
            [pessoas]='^(src/pages/pessoas/|src/components/pessoas/|src/components/membros/)'
            [agenda]='^src/components/agenda/'
            [familia]='^src/components/familia/'
            [jornadas]='^src/components/jornadas/'
            [pedidos]='^src/components/pedidos/'
            [perfil]='^src/components/perfil/'
            [projetos]='^src/components/projetos/'
            [comunicacao]='^(src/components/comunicados/|src/components/publicacao/)'
            [sentimentos]='^src/components/sentimentos/'
            [testemunhos]='^src/components/testemunhos/'
            [visitantes]='^src/components/visitantes/'
            [voluntario]='^src/components/voluntario/'
            [layout-ui]='^(src/components/layout/|src/components/ui/|src/assets/|src/lib/|src/hooks/|src/utils/)'
            [integrations]='^src/integrations/'
          )

          touched=()
          for m in "${!MODULES[@]}"; do
            rx="${MODULES[$m]}"
            if echo "$changed" | tr ' ' '\n' | grep -E "$rx" >/dev/null 2>&1; then
              touched+=("$m")
            fi
          done

          if [ ${#touched[@]} -eq 0 ]; then
            echo "No mapped modules touched; skipping docs enforcement."
            exit 0
          fi

          echo "Touched modules: ${touched[*]}"

          if [ -z "$DOCS_CHANGED" ]; then
            echo "::error::Módulos tocados (${touched[*]}), mas nenhuma mudança em docs/. Atualize a documentação antes do merge."
            exit 1
          fi

          echo "Docs updated ✅"
