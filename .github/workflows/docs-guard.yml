name: Docs Guard (Hard + Fix Mode)

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  docs_guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get changed files
        id: changed
        uses: tj-actions/changed-files@v45

      - name: Enforce documentation discipline
        shell: bash
        run: |
          set -euo pipefail

          echo "==============================="
          echo "Docs Guard — Hard + Fix Mode"
          echo "==============================="

          changed="${{ steps.changed.outputs.all_changed_files }}"
          echo "Changed files:"
          echo "$changed" | tr ' ' '\n'

          # --------------------------------
          # Detect PR labels
          # --------------------------------
          PR_LABELS="${{ github.event.pull_request.labels.*.name }}"
          FIX_MODE=$(echo "$PR_LABELS" | tr ' ' '\n' | grep -E '^doc:fix$' || true)

          if [ -n "$FIX_MODE" ]; then
            echo "PR label detected: doc:fix → FIX MODE enabled"
          else
            echo "No doc:fix label → HARD MODE enabled"
          fi

          # --------------------------------
          # Detect documentation changes
          # --------------------------------
          DOCS_CHANGED=$(echo "$changed" | tr ' ' '\n' | grep -E '^docs/' || true)
          DIAGRAM_CHANGED=$(echo "$changed" | tr ' ' '\n' | grep -E '^docs/diagramas/' || true)
          TEXT_DOC_CHANGED=$(echo "$changed" | tr ' ' '\n' | grep -E '^docs/(manual-usuario\.md|funcionalidades\.md|produto/|01-Arquitetura/|adr/)' || true)

          # --------------------------------
          # Module path mapping (REAL paths)
          # --------------------------------
          declare -A MODULES=(
            [admin]='^(src/pages/admin/|src/components/admin/)'
            [auth]='^(src/pages/auth/|src/components/auth/|src/integrations/supabase/)'
            [cadastro]='^src/pages/cadastro/'
            [cultos]='^(src/pages/cultos/|src/components/cultos/)'
            [dashboard]='^src/components/dashboard/'
            [ensino]='^(src/pages/ensino/|src/components/ensino/)'
            [financas]='^(src/pages/financas/|src/components/financas/)'
            [intercessao]='^src/pages/intercessao/'
            [kids]='^(src/pages/kids/|src/components/kids/)'
            [pessoas]='^(src/pages/pessoas/|src/components/pessoas/|src/components/membros/)'
            [agenda]='^src/components/agenda/'
            [familia]='^src/components/familia/'
            [jornadas]='^src/components/jornadas/'
            [pedidos]='^src/components/pedidos/'
            [perfil]='^src/components/perfil/'
            [projetos]='^src/components/projetos/'
            [comunicacao]='^(src/components/comunicados/|src/components/publicacao/)'
            [sentimentos]='^src/components/sentimentos/'
            [testemunhos]='^src/components/testemunhos/'
            [visitantes]='^src/components/visitantes/'
            [voluntario]='^src/components/voluntario/'
            [layout-ui]='^(src/components/layout/|src/components/ui/|src/assets/|src/lib/|src/hooks/|src/utils/)'
            [integrations]='^src/integrations/'
          )

          touched=()
          for m in "${!MODULES[@]}"; do
            if echo "$changed" | tr ' ' '\n' | grep -E "${MODULES[$m]}" >/dev/null 2>&1; then
              touched+=("$m")
            fi
          done

          if [ ${#touched[@]} -eq 0 ]; then
            echo "No mapped modules touched; skipping docs enforcement."
            exit 0
          fi

          echo "Touched modules: ${touched[*]}"

          # ============================================================
          # FIX MODE — minimal documentation required
          # ============================================================
          if [ -n "$FIX_MODE" ]; then
            if [ -z "$DOCS_CHANGED" ]; then
              echo "::error::PR marcada como doc:fix, mas nenhuma atualização mínima em docs/ foi encontrada."
              exit 1
            fi

            echo "Minimal documentation for fix detected ✅"
            exit 0
          fi

          # ============================================================
          # HARD MODE — full documentation required
          # ============================================================

          # Rule 1: docs/ must change
          if [ -z "$DOCS_CHANGED" ]; then
            echo "::error::Código foi alterado (${touched[*]}), mas nenhuma mudança em docs/. Documentação é obrigatória."
            exit 1
          fi

          # Rule 2: at least one diagram must change
          if [ -z "$DIAGRAM_CHANGED" ]; then
            echo "::error::É obrigatório atualizar/criar ao menos um diagrama em docs/diagramas/ para os módulos: ${touched[*]}"
            exit 1
          fi

          # Rule 3: at least one textual doc must change
          if [ -z "$TEXT_DOC_CHANGED" ]; then
            echo "::error::Além de diagramas, é obrigatório atualizar documentação textual (manual, funcionalidades, produto, arquitetura ou ADR)."
            exit 1
          fi

          echo "Full documentation requirements satisfied ✅"
