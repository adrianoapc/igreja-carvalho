# üìã Cat√°logo de Automa√ß√µes

Este documento lista todas as automa√ß√µes existentes no sistema.
Nenhuma automa√ß√£o deve ser criada sem atualiza√ß√£o deste cat√°logo.

| Automa√ß√£o                                      | Tipo               | Onde Vive (Path Real)                                                       | Disparo                                                                           | M√≥dulo Afetado            | O que Faz                                                                                                                                                                                                                                                                                                                                                              | Impacto                                                                                                                                                                     | Refer√™ncias                                                                                     |
| ---------------------------------------------- | ------------------ | --------------------------------------------------------------------------- | --------------------------------------------------------------------------------- | ------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------- |
| Edge Function ¬∑ biometric-login                | Edge Function      | supabase/functions/biometric-login/index.ts                                 | HTTP POST /functions/v1/biometric-login                                           | Auth                      | Verifica credentialId recebido com profiles.biometric_credential_id e responde sucesso ou erro.                                                                                                                                                                                                                                                                        | Sustenta login biom√©trico sem expor chaves privilegiadas no client.                                                                                                         | n/a                                                                                             |
| Edge Function ¬∑ cadastro-publico               | Edge Function      | supabase/functions/cadastro-publico/index.ts                                | HTTP POST /functions/v1/cadastro-publico                                          | Pessoas                   | Processa a√ß√µes de cadastro de visitante, busca e atualiza√ß√£o de membro com rate-limit e notify_admins.                                                                                                                                                                                                                                                                 | Automatiza capta√ß√£o externa e promove visitantes recorrentes sem interven√ß√£o manual.                                                                                        | n/a                                                                                             |
| Edge Function ¬∑ checkin-evento                 | Edge Function      | supabase/functions/checkin-evento/index.ts                                  | HTTP POST /functions/v1/checkin-evento                                            | Cultos & Ensino           | Aplica rate-limit, encontra pessoa por email/telefone e grava presen√ßa em presencas_culto ou presencas_aula.                                                                                                                                                                                                                                                           | Garante registro imediato de presen√ßas por QR Code evitando duplicidades.                                                                                                   | n/a                                                                                             |
| Edge Function ¬∑ checkin-inscricao              | Edge Function      | supabase/functions/checkin-inscricao/index.ts                               | HTTP POST /functions/v1/checkin-inscricao                                         | Eventos                   | Valida QR de inscri√ß√£o, bloqueia reuso, verifica pagamento e registra presen√ßa em checkins.                                                                                                                                                                                                                                                                            | Permite check-in presencial por volunt√°rio usando QR √∫nico da inscri√ß√£o.                                                                                                    | n/a                                                                                             |
| Edge Function ¬∑ inscricao-compartilhe          | Edge Function      | supabase/functions/inscricao-compartilhe/index.ts                           | Webhook Make com x-webhook-secret v√°lido                                          | Eventos                   | Fluxo WhatsApp COMPARTILHE: confirma dados, encontra evento de a√ß√£o social aberto, cria inscri√ß√£o e devolve QR.                                                                                                                                                                                                                                                        | Automatiza inscri√ß√µes via WhatsApp com confirma√ß√£o e QR individual.                                                                                                         | n/a                                                                                             |
| Edge Function ¬∑ inscricoes-lembretes           | Edge Function      | supabase/functions/inscricoes-lembretes/index.ts                            | Agendamento (cron a cada 15 min)                                                  | Eventos                   | Envia lembretes 12h antes do vencimento e cancela inscri√ß√µes pendentes ap√≥s 24h, notificando via WhatsApp.                                                                                                                                                                                                                                                             | Mant√©m vagas dispon√≠veis e reduz no-shows por falta de pagamento.                                                                                                           | n/a                                                                                             |
| Edge Function ¬∑ checkin-whatsapp-geo           | Edge Function      | supabase/functions/checkin-whatsapp-geo/index.ts                            | Webhook Make com x-webhook-secret v√°lido                                          | Cultos                    | Valida segredo, limita requisi√ß√µes e delega checkin_por_localizacao para registrar presen√ßa por geolocaliza√ß√£o.                                                                                                                                                                                                                                                        | Permite check-in via WhatsApp/Make controlando fraude por dist√¢ncia.                                                                                                        | supabase/migrations/20251203014529_33465599-90b0-469a-aad4-478cb8b45d9b.sql                     |
| Edge Function ¬∑ chatbot-triagem                | Edge Function      | supabase/functions/chatbot-triagem/index.ts                                 | HTTP POST /functions/v1/chatbot-triagem (verify_jwt=false)                        | Intercess√£o & Evangelismo | Triagem via WhatsApp: mant√©m sess√£o em `atendimentos_bot`, transcreve √°udio (Whisper), chama `gpt-4o-mini`, registra audit log e cria pedidos/testemunhos/solicita√ß√µes pastorais vinculando membro ou lead.                                                                                                                                                            | Automatiza acolhimento pastoral 24/7 sem expor credenciais sens√≠veis.                                                                                                       | docs/adr/ADR-012: M√≥dulo Intercess√£o V2, CRM de Evangelismo e Chatbot Multimodal                |
| Edge Function ¬∑ analise-sentimento-ia          | Edge Function      | supabase/functions/analise-sentimento-ia/index.ts                           | Trigger: AFTER INSERT ON sentimentos_membros                                      | Intercess√£o & Gabinete    | Analisa sentimento via IA (Lovable Gemini), identifica padr√£o cr√≠tico (3+ negativos) e cria `atendimentos_pastorais` com gravidade autom√°tica; notifica pastor respons√°vel.                                                                                                                                                                                            | Detec√ß√£o autom√°tica de membros em risco emocional, gatilho de interven√ß√£o pastoral proativa.                                                                                | docs/adr/ADR-014-gabinete-digital-e-roteamento-pastoral.md                                      |
| Edge Function ¬∑ analise-pedido-ia              | Edge Function      | supabase/functions/analise-pedido-ia/index.ts                               | Trigger: AFTER INSERT ON pedidos_oracao                                           | Intercess√£o & Gabinete    | Analisa pedido de ora√ß√£o via IA (Lovable Gemini), preenche `analise_ia_titulo`, `analise_ia_motivo`, `analise_ia_gravidade`, `analise_ia_resposta` e cria `atendimentos_pastorais` para gravidade >= MEDIA.                                                                                                                                                            | Triagem autom√°tica de pedidos com detec√ß√£o de urg√™ncia e roteamento ao pastor.                                                                                              | docs/adr/ADR-014-gabinete-digital-e-roteamento-pastoral.md                                      |
| Edge Function ¬∑ disparar-alerta                | Edge Function      | supabase/functions/disparar-alerta/index.ts                                 | HTTP POST /functions/v1/disparar-alerta                                           | Notifica√ß√µes              | Resolve notificacao_regras, formata mensagens e envia in-app, WhatsApp (Make ou Meta) e push placeholder. **Webhooks agora scoped por `igreja_id` da notifica√ß√£o**.                                                                                                                                                                                                    | Centraliza disparo multi-canal de alertas configur√°veis.                                                                                                                    | docs/adr/ADR-007-estrategia-entrega-notificacoes.md<br>docs/diagramas/sequencia-notificacoes.md |
| Edge Function ¬∑ notificar-aniversarios         | Edge Function      | supabase/functions/notificar-aniversarios/index.ts                          | pg_cron via edge_function_config (cron 0 11 \* \* \*, a confirmar)                | Pessoas                   | Busca anivers√°rios do dia seguinte, envia notify_admins e registra log_edge_function_execution.                                                                                                                                                                                                                                                                        | Mant√©m lideran√ßa informada com anteced√™ncia sobre datas importantes.                                                                                                        | supabase/migrations/20251129185658_24ffb3f2-2e02-4d48-941a-5c13c9068b1f.sql                     |
| Edge Function ¬∑ notificar-liturgia-make        | Edge Function      | supabase/functions/notificar-liturgia-make/index.ts                         | HTTP POST /functions/v1/notificar-liturgia-make                                   | Cultos                    | Consolida liturgia do culto e publica JSON no webhook configurado no Make. **Busca webhook na tabela `webhooks` por `igreja_id` e tipo `make_liturgia`**.                                                                                                                                                                                                              | Sincroniza planejamento de liturgia com automa√ß√µes externas.                                                                                                                | supabase/migrations/20251130053509_fdcb9999-e713-42fb-822c-0e80423f1d9b.sql                     |
| Edge Function ¬∑ notificar-sentimentos-diario   | Edge Function      | supabase/functions/notificar-sentimentos-diario/index.ts                    | pg_cron via edge_function_config (cron 0 12 \* \* \*, a confirmar)                | Sentimentos               | Lista membros ativos, gera notifica√ß√µes sentimento_diario e registra execu√ß√£o.                                                                                                                                                                                                                                                                                         | Estimula check-ins emocionais di√°rios sem a√ß√£o manual da equipe.                                                                                                            | supabase/migrations/20251129185658_24ffb3f2-2e02-4d48-941a-5c13c9068b1f.sql                     |
| Edge Function ¬∑ playlist-oracao                | Edge Function      | supabase/functions/playlist-oracao/index.ts                                 | HTTP POST /functions/v1/playlist-oracao (body: evento_id opcional)                | Ora√ß√£o & Intercess√£o      | Busca sentimentos (24h), testemunhos p√∫blicos (top 3), visitantes (7 dias), pedidos broadcast e pessoais; se evento_id fornecido, busca liturgia e monta array de slides combinando itens manuais + 5 blocos inteligentes (testemunhos, alerta espiritual, visitantes, broadcast, pessoais); retorna JSON com alerta/testemunhos/visitantes/broadcast/pessoais/slides. | Fornece conte√∫do din√¢mico para o Player do Rel√≥gio de Ora√ß√£o, orquestrando montagem de slides com dados reais da igreja; usado por hook useLiturgiaInteligente no frontend. | supabase/migrations/20251230000000_add_blocos_inteligentes.sql                                  |
| Edge Function ¬∑ processar-nota-fiscal          | Edge Function      | supabase/functions/processar-nota-fiscal/index.ts                           | HTTP POST autenticado /functions/v1/processar-nota-fiscal                         | Finan√ßas                  | Valida sess√£o e cargos, envia imagem ao Lovable Gemini e retorna dados estruturados da nota.                                                                                                                                                                                                                                                                           | Acelera confer√™ncia de comprovantes financeiros com OCR assistido.                                                                                                          | n/a                                                                                             |
| Edge Function ¬∑ pix-webhook                    | Edge Function      | supabase/functions/pix-webhook/index.ts                                     | HTTP GET/POST /functions/v1/pix-webhook (health check GET, payload PIX Santander) | Finan√ßas                  | Recebe notifica√ß√µes PIX padr√£o BACEN do Santander, identifica `igreja_id` pela chave CNPJ, grava na tabela `pix_webhook_temp` com status `recebido` e registra payload bruto; CORS liberado para opera√ß√£o banc√°ria.                                                                                                                                                    | Permite ingest√£o direta de PIX para concilia√ß√£o, sem expor credenciais no frontend; compat√≠vel com health check exigido pelo banco.                                         | docs/WEBHOOK_PIX_README.md                                                                      |
| Edge Function ¬∑ finance-sync                   | Edge Function      | supabase/functions/finance-sync/index.ts                                    | HTTP GET/POST /functions/v1/finance-sync?provider=‚Ä¶&op=‚Ä¶                          | Finan√ßas                  | Esqueleto de sincroniza√ß√£o com provedores externos; responde mock de itens e loga payload, preparando integra√ß√£o com `financeiro_config`.                                                                                                                                                                                                                              | Base para futura concilia√ß√£o autom√°tica sem expor credenciais no frontend.                                                                                                  | docs/PLANEJAMENTO_GESTAO_OFERTAS.md (a confirmar)                                               |
| Edge Function ¬∑ criar-usuario                  | Edge Function      | supabase/functions/criar-usuario/index.ts                                   | HTTP POST /functions/v1/criar-usuario                                             | Pessoas / Auth            | Cria usu√°rio via Admin API (`createUser`), atualiza `profiles.user_id`, for√ßa troca de senha e permite reset de senha por `action=reset_password`.                                                                                                                                                                                                                     | Destrava provisionamento de acesso (evita INSERT direto em auth.users) e habilita reset seguro.                                                                             | docs/USER_CREATION_FIX.md                                                                       |
| Edge Function ¬∑ manage-users                   | Edge Function      | supabase/functions/manage-users/index.ts                                    | HTTP POST /functions/v1/manage-users (verify_jwt=false)                           | Pessoas / Auth            | Cria√ß√£o e reset de usu√°rio por Admin API com fallback de role `membro` e limpeza caso falhe o v√≠nculo em `profiles`.                                                                                                                                                                                                                                                   | Alternativa simplificada para provisionar acessos sem expor chave de servi√ßo no client.                                                                                     | supabase/config.toml                                                                            |
| Edge Function ¬∑ receber-pedido-make            | Edge Function      | supabase/functions/receber-pedido-make/index.ts                             | Webhook Make com x-webhook-secret v√°lido                                          | Intercess√£o               | Valida payload via zod, tenta vincular pessoa (buscar_pessoa_por_contato) e insere pedido de ora√ß√£o.                                                                                                                                                                                                                                                                   | Conecta formul√°rios externos ao pipeline pastoral com consist√™ncia de dados.                                                                                                | supabase/migrations/20251217042013_54ab2017-7153-496e-9edd-5cf8c437b180.sql                     |
| Edge Function ¬∑ receber-testemunho-make        | Edge Function      | supabase/functions/receber-testemunho-make/index.ts                         | Webhook Make com x-webhook-secret v√°lido                                          | Testemunhos               | Valida webhook, gera t√≠tulo autom√°tico e salva testemunho vinculando autor quando poss√≠vel.                                                                                                                                                                                                                                                                            | Automatiza entrada de testemunhos oriundos de automa√ß√µes externas.                                                                                                          | n/a                                                                                             |
| Edge Function ¬∑ verificar-escalas-pendentes    | Edge Function      | supabase/functions/verificar-escalas-pendentes/index.ts                     | pg_cron (cron.schedule 'lembrete-diario-escalas', a confirmar)                    | Escalas                   | Procura escalas pendentes a 24-48h do culto e chama disparar-alerta para cada volunt√°rio. **Webhooks scoped por `igreja_id`**.                                                                                                                                                                                                                                         | Reduz faltas lembrando volunt√°rios dos compromissos com anteced√™ncia.                                                                                                       | docs/diagramas/sequencia-notificacoes.md                                                        |
| Edge Function ¬∑ verificar-sentimentos-criticos | Edge Function      | supabase/functions/verificar-sentimentos-criticos/index.ts                  | pg_cron via edge_function_config (cron 0 11 \* \* \*, a confirmar)                | Sentimentos               | Analisa 7 dias de sentimentos, identifica casos cr√≠ticos e notifica admins al√©m de acionar webhook Make.                                                                                                                                                                                                                                                               | D√° visibilidade r√°pida sobre membros com padr√£o emocional preocupante.                                                                                                      | supabase/migrations/20251129185658_24ffb3f2-2e02-4d48-941a-5c13c9068b1f.sql                     |
| Trigger ¬∑ trigger_notify_new_visitor           | Trigger (Postgres) | supabase/migrations/20251127201908_064e205a-4152-47c8-9488-402f12d3278a.sql | AFTER INSERT ON public.profiles                                                   | Pessoas                   | Quando perfil √© criado com status visitante, executa notify_admins com resumo do cadastro.                                                                                                                                                                                                                                                                             | Alerta administra√ß√£o sobre novos visitantes assim que entram no sistema.                                                                                                    | docs/database-schema.sql                                                                        |
| Trigger ¬∑ trigger_notify_status_promotion      | Trigger (Postgres) | supabase/migrations/20251127201908_064e205a-4152-47c8-9488-402f12d3278a.sql | AFTER UPDATE ON public.profiles                                                   | Pessoas                   | Detecta mudan√ßa de status e envia notify_admins com detalhes da promo√ß√£o.                                                                                                                                                                                                                                                                                              | Mant√©m lideran√ßa informada sobre evolu√ß√µes de status dos membros.                                                                                                           | docs/database-schema.sql                                                                        |
| Trigger ¬∑ trigger_notify_role_assignment       | Trigger (Postgres) | supabase/migrations/20251127201908_064e205a-4152-47c8-9488-402f12d3278a.sql | AFTER INSERT ON public.user_roles                                                 | Admin                     | Ao atribuir cargo, busca nome do usu√°rio e notifica admins sobre a nova fun√ß√£o.                                                                                                                                                                                                                                                                                        | Cria trilha audit√°vel para concess√£o de pap√©is sens√≠veis.                                                                                                                   | docs/database-schema.sql                                                                        |
| Trigger ¬∑ trigger_notify_role_removal          | Trigger (Postgres) | supabase/migrations/20251127201908_064e205a-4152-47c8-9488-402f12d3278a.sql | AFTER DELETE ON public.user_roles                                                 | Admin                     | Notifica admins quando um cargo √© removido incluindo metadados da a√ß√£o.                                                                                                                                                                                                                                                                                                | Garante visibilidade sobre revoga√ß√£o de acessos administrativos.                                                                                                            | docs/database-schema.sql                                                                        |
| Trigger ¬∑ trigger_notify_new_pedido_oracao     | Trigger (Postgres) | supabase/migrations/20251129182548_fbd6269d-e39f-4e1c-872c-8debc4ed61af.sql | AFTER INSERT ON public.pedidos_oracao                                             | Intercess√£o               | Formata exibi√ß√£o an√¥nima ou identificada e dispara notify_admins com dados do pedido.                                                                                                                                                                                                                                                                                  | Faz a equipe pastoral ser avisada assim que um pedido chega.                                                                                                                | docs/database-schema.sql                                                                        |
| Trigger ¬∑ trigger_notify_new_testemunho        | Trigger (Postgres) | supabase/migrations/20251128213908_ad96cd4b-d1fb-45db-8260-64d378ee43a5.sql | AFTER INSERT ON public.testemunhos                                                | Testemunhos               | Consulta autor, trata anonimiza√ß√£o e cria notifica√ß√£o do novo testemunho.                                                                                                                                                                                                                                                                                              | Publica√ß√£o de testemunhos gera alerta imediato para curadoria.                                                                                                              | docs/database-schema.sql                                                                        |
| Trigger ¬∑ trigger_notify_kids_diario           | Trigger (Postgres) | supabase/migrations/20251209_kids_notifications.sql                         | AFTER INSERT ON public.kids_diario                                                | Kids                      | Identifica respons√°vel (familias ou responsavel_id) e insere notifica√ß√£o kids_diario para o app.                                                                                                                                                                                                                                                                       | Respons√°veis recebem push assim que o di√°rio da crian√ßa √© publicado.                                                                                                        | docs/NOTIFICACOES_KIDS.md                                                                       |
| Trigger ¬∑ trigger_notify_kids_checkout         | Trigger (Postgres) | supabase/migrations/20251209_kids_notifications.sql                         | AFTER UPDATE ON public.kids_checkins                                              | Kids                      | Quando checkout_at deixa de ser nulo, dispara notifica√ß√£o kids_checkout ao respons√°vel.                                                                                                                                                                                                                                                                                | Confirma sa√≠da das crian√ßas para os respons√°veis em tempo real.                                                                                                             | docs/NOTIFICACOES_KIDS.md                                                                       |
| Trigger ¬∑ kids_checkin_registra_presenca       | Trigger (Postgres) | supabase/migrations/20251209_kids_presence_on_checkin.sql                   | AFTER INSERT ON public.kids_checkins                                              | Kids & Cultos             | Ao registrar check-in, grava presen√ßa da crian√ßa e do respons√°vel em presencas_culto.                                                                                                                                                                                                                                                                                  | Atualiza dashboards de presen√ßa imediatamente na entrada do Kids.                                                                                                           | docs/SPRINT_KIDS_SUMMARY.md                                                                     |
| Trigger ¬∑ trigger_sync_intercessor_insert      | Trigger (Postgres) | supabase/migrations/20251217235317_75837073-ac59-4ed9-9c6b-8f84c9bedf00.sql | AFTER INSERT ON public.membros_time                                               | Intercess√£o               | Quando membro entra em time com nome Intercess√£o/Ora√ß√£o/Clamor, cria ou reativa registro na tabela intercessores.                                                                                                                                                                                                                                                      | Mant√©m base de intercessores alinhada com composi√ß√£o dos times ministeriais.                                                                                                | docs/adr/ADR-011-evolucao-ministerio-intercessao.md                                             |
| Trigger ¬∑ trigger_sync_intercessor_delete      | Trigger (Postgres) | supabase/migrations/20251217235317_75837073-ac59-4ed9-9c6b-8f84c9bedf00.sql | AFTER DELETE ON public.membros_time                                               | Intercess√£o               | Desativa intercessor correspondente quando o membro sai do time de intercess√£o.                                                                                                                                                                                                                                                                                        | Evita escalar pedidos para quem n√£o est√° mais ativo no minist√©rio.                                                                                                          | docs/adr/ADR-011-evolucao-ministerio-intercessao.md                                             |
| Trigger ¬∑ trigger_atualizar_saldo_conta        | Trigger (Postgres) | supabase/migrations/20251130045754_7c619efc-d67a-4da9-a6bf-1e7ab51cab83.sql | AFTER UPDATE ON public.transacoes_financeiras                                     | Finan√ßas                  | Ajusta contas.saldo_atual conforme transa√ß√£o muda para pago ou deixa de estar paga (entrada/sa√≠da).                                                                                                                                                                                                                                                                    | Mant√©m saldo das contas refletindo liquida√ß√µes sem necessidade de jobs externos.                                                                                            | docs/database-schema.sql                                                                        |
