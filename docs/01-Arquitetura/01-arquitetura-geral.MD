# Arquitetura Geral

## VisÃ£o Geral
O sistema Igreja Carvalho Ã© uma aplicaÃ§Ã£o web construÃ­da em React,
utilizando Supabase como backend (Auth + Banco de Dados + SeguranÃ§a).

### Fluxo macro do sistema
Este diagrama mostra o caminho de uma requisiÃ§Ã£o autenticada: frontend aciona Supabase Auth, o Postgres aplica RLS e retorna dados filtrados. ReferÃªncias: [`../adr/ADR-002-autenticacao-supabase.md`](../adr/ADR-002-autenticacao-supabase.md) e [`../adr/ADR-003-rls-e-modelo-permissoes.md`](../adr/ADR-003-rls-e-modelo-permissoes.md).

```mermaid
flowchart LR
    U[UsuÃ¡rio] -->|Browser| FE[Frontend (React + Vite)]
    FE -->|Credenciais| AUTH[Supabase Auth]
    FE -->|Queries| PG[Postgres]
    PG -->|Enforce| RLS[Row Level Security]
    RLS --> FE
```

## Componentes
- Frontend: React + Vite + Tailwind
- Backend: Supabase (Postgres + Auth)
- SeguranÃ§a: Row Level Security (RLS)

## Diagrama
VisÃ£o resumida do caminho request â†’ auth â†’ dados, ligada ao manual e funcionalidades. ReferÃªncias: [`../manual-usuario.md`](../manual-usuario.md) e [`../funcionalidades.md`](../funcionalidades.md).
```mermaid
flowchart LR
    User[UsuÃ¡rio] -->|Browser| Frontend[React + Vite]
    Frontend -->|Login| Auth[Supabase Auth]
    Frontend -->|Queries| DB[(Postgres)]
    DB -->|RLS| Policies[PolÃ­ticas de SeguranÃ§a]



---

# ğŸ” AutenticaÃ§Ã£o

## `docs/01-arquitetura/04-autenticacao.md`

```md
# AutenticaÃ§Ã£o

O sistema utiliza Supabase Auth para controle de usuÃ¡rios e sessÃµes.

## Fluxo
```mermaid
sequenceDiagram
    User->>Frontend: Login
    Frontend->>SupabaseAuth: Credenciais
    SupabaseAuth-->>Frontend: JWT
    Frontend->>DB: Requests autenticadas



---

# ğŸ” AutenticaÃ§Ã£o

## `docs/01-arquitetura/04-autenticacao.md`

```md
# AutenticaÃ§Ã£o

O sistema utiliza Supabase Auth para controle de usuÃ¡rios e sessÃµes.

## Fluxo
```mermaid
sequenceDiagram
    User->>Frontend: Login
    Frontend->>SupabaseAuth: Credenciais
    SupabaseAuth-->>Frontend: JWT
    Frontend->>DB: Requests autenticadas



---

# ğŸ—„ï¸ 02 â€” Backend (Supabase)

## `docs/02-backend-supabase/01-modelo-de-dados.md`

```md
# Modelo de Dados

O Supabase utiliza PostgreSQL como banco relacional.

## Entidades principais
- users (auth)
- pessoas
- perfis
- relacionamentos ministeriais

## Modelo Relacional
```mermaid
erDiagram
    USERS ||--o{ PESSOAS : possui
    PESSOAS ||--o{ PERFIS : assume



## `docs/02-backend-supabase/03-rls-politicas.md`

```md
# PolÃ­ticas de SeguranÃ§a (RLS)

O acesso aos dados Ã© controlado por Row Level Security.

## Exemplo
- UsuÃ¡rio sÃ³ visualiza dados da sua igreja
- Perfis definem permissÃµes de escrita

## Fluxo
```mermaid
flowchart LR
    Request --> Auth
    Auth --> Role
    Role --> RLS
    RLS --> DB


## VisÃ£o de AutenticaÃ§Ã£o (Supabase Auth)

- UsuÃ¡rios e sessÃµes gerenciados via Supabase Auth (JWT).
- Frontend usa `supabase-js` e persiste sessÃ£o no `localStorage`.
- Papel/base (admin, tecnico, lider, membro) mapeado em `user_roles` e usado pelo RLS.

### SequÃªncia de autenticaÃ§Ã£o e uso do JWT
Diagrama resume login, refresh de sessÃ£o e uso do JWT nas queries. ReferÃªncias: [`02-autenticacao-supabase.MD`](02-autenticacao-supabase.MD) e [`../adr/ADR-002-autenticacao-supabase.md`](../adr/ADR-002-autenticacao-supabase.md).

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant SupabaseAuth as Supabase Auth
    participant DB

    User->>Frontend: Login (senha/magic link)
    Frontend->>SupabaseAuth: Credenciais
    SupabaseAuth-->>Frontend: JWT + refresh token
    Frontend->>DB: Query com JWT
    DB-->>Frontend: Dados filtrados por RLS
    Frontend->>SupabaseAuth: Refresh token (antes de expirar)
    SupabaseAuth-->>Frontend: Novo JWT
    Frontend->>DB: Novas queries com JWT renovado
```

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant SupabaseAuth as Supabase Auth
    participant DB

    User->>Frontend: Cria sessÃ£o (login/signup)
    Frontend->>SupabaseAuth: Credenciais / Magic Link
    SupabaseAuth-->>Frontend: JWT + refresh token
    Frontend->>DB: Chamada autenticada (JWT)
    DB-->>Frontend: Dados filtrados por RLS
```

## VisÃ£o de Fluxo de Dados (Frontend â†’ Supabase â†’ RLS â†’ DB)

Fluxo detalha a validaÃ§Ã£o de sessÃ£o pelo client Supabase, checagem de claims para RLS e retorno filtrado. ReferÃªncias: [`03-fluxo-de-dados.MD`](03-fluxo-de-dados.MD) e [`../adr/ADR-003-rls-e-modelo-permissoes.md`](../adr/ADR-003-rls-e-modelo-permissoes.md).

```mermaid
flowchart TD
    FE[Frontend (supabase-js)] -->|Query/RPC/Storage| EDGE[Supabase Edge/PostgREST]
    EDGE -->|Valida JWT + session| AUTH[Supabase Auth]
    EDGE -->|Claims (sub, role, igreja)| RLS[RLS Policies]
    RLS --> PG[(Postgres)]
    PG --> FE
```

```mermaid
flowchart TD
    U[UsuÃ¡rio] --> FE[Frontend React]
    FE -->|RPC/SQL/Storage| SB[Supabase Edge/API]
    SB -->|JWT claims| RLS[RLS Policies]
    RLS --> PG[(Postgres)]
    PG --> FE

    subgraph AuthZ
    RLS
    end
```

## ReferÃªncias e Diagramas
- Diagramas relacionados: [`../diagramas/`](../diagramas/)
- Detalhe de autenticaÃ§Ã£o: [`02-autenticacao-supabase.MD`](02-autenticacao-supabase.MD)
- Fluxo de dados detalhado: [`03-fluxo-de-dados.MD`](03-fluxo-de-dados.MD)
- RLS e seguranÃ§a: [`04-rls-e-seguranca.MD`](04-rls-e-seguranca.MD)

---

## MÃ³dulo Financeiro (VisÃ£o TÃ©cnica)

### Objetivo
Prover controle financeiro com separaÃ§Ã£o clara entre **Fato Gerador** (competÃªncia), **Fluxo de Caixa** (pagamentos) e **DRE** (resultado contÃ¡bil), garantindo relatÃ³rios precisos e auditÃ¡veis.

---

## MÃ³dulo Pessoas / Membros (visÃ£o tÃ©cnica)

### Como o frontend carrega e persiste dados

### InteraÃ§Ã£o com Supabase

### ConsideraÃ§Ãµes de RLS / permissÃµes / multi-tenant

### Diagramas relacionados
O mÃ³dulo financeiro utiliza uma arquitetura de trÃªs camadas, conforme documentado no [ADR-001](../adr/ADR-001-separacao-fato-gerador-caixa-dre.md):

#### 1. Camada de CompetÃªncia (Fato Gerador)
- **Tabelas**: `itens_reembolso`, `categorias_financeiras`, `fornecedores`
- **FunÃ§Ã£o**: Registrar a natureza e o momento da decisÃ£o de gastar/receber
- **Acesso**: Controlado por RLS (apenas dados da prÃ³pria igreja)
- **OperaÃ§Ãµes no Frontend**:
  - `INSERT`: Registrar novo fato gerador (categoria, fornecedor, valor)
  - `UPDATE`: Reclassificar categoria ou ajustar competÃªncia
  - `DELETE`: Estornar fato gerador (requer justificativa)

#### 2. Camada de Caixa (TransaÃ§Ãµes)
- **Tabelas**: `transacoes_financeiras`, `contas`, `formas_pagamento`
- **FunÃ§Ã£o**: Registrar quando e como o dinheiro efetivamente movimentou
- **Acesso**: RLS filtra por `igreja_id` e role (tesoureiro/admin)
- **OperaÃ§Ãµes no Frontend**:
  - `INSERT`: Criar transaÃ§Ã£o de pagamento/recebimento
  - `UPDATE`: Confirmar pagamento, adicionar juros/multas/descontos
  - `DELETE`: Estornar pagamento (requer justificativa)

#### 3. Camada de InteligÃªncia (DRE e RelatÃ³rios)
- **Views**: `view_contabil_unificada`, `view_dre_anual`
- **FunÃ§Ã£o**: Cruzar competÃªncia + caixa para gerar relatÃ³rios
- **Acesso**: RLS automÃ¡tico via views (herdam polÃ­ticas das tabelas base)
- **OperaÃ§Ãµes no Frontend**:
  - `SELECT`: Consultar DRE, projeÃ§Ãµes, reconciliaÃ§Ã£o
  - **Nenhuma escrita**: Views sÃ£o read-only

### IntegraÃ§Ã£o com Supabase

#### Row Level Security (RLS)
Todas as tabelas financeiras aplicam RLS para garantir isolamento multi-igreja:

```sql
-- Exemplo de polÃ­tica (pseudo-cÃ³digo)
CREATE POLICY select_own_church ON transacoes_financeiras
FOR SELECT
USING (
  igreja_id = current_setting('request.jwt.claim.igreja_id')::uuid
);

CREATE POLICY insert_treasurer_only ON transacoes_financeiras
FOR INSERT
WITH CHECK (
  igreja_id = current_setting('request.jwt.claim.igreja_id')::uuid
  AND current_setting('request.jwt.claim.role') IN ('admin', 'tesoureiro')
);
```

**PapÃ©is e PermissÃµes**:
- `admin`: Acesso completo (CRUD em todas as camadas)
- `tesoureiro`: CRUD em transaÃ§Ãµes e fatos geradores; leitura em relatÃ³rios
- `lider`: Leitura em relatÃ³rios de sua base ministerial
- `membro`: Sem acesso ao mÃ³dulo financeiro (a menos que explicitamente autorizado)

#### Queries e RPCs
O frontend executa queries via Supabase Client (`@supabase/supabase-js`):

**Criar Fato Gerador**:
```typescript
const { data, error } = await supabase
  .from('itens_reembolso')
  .insert({
    categoria_id: categoriaId,
    fornecedor_id: fornecedorId,
    valor_original: 500.00,
    data_competencia: '2024-12-01',
    igreja_id: currentUser.igreja_id
  });
```

**Confirmar Pagamento**:
```typescript
const { data, error } = await supabase
  .from('transacoes_financeiras')
  .update({
    status: 'Pago',
    data_pagamento: '2024-12-10',
    juros: 0,
    descontos: 0
  })
  .eq('id', transacaoId);
```

**Consultar DRE (via View)**:
```typescript
const { data, error } = await supabase
  .from('view_dre_anual')
  .select('*')
  .eq('ano', 2024)
  .order('categoria');
```

**RPC para ReconciliaÃ§Ã£o BancÃ¡ria**:
```typescript
const { data, error } = await supabase
  .rpc('reconciliar_transacoes', {
    conta_id: contaId,
    extrato: [...] // Array de lanÃ§amentos do banco
  });
```

### Fluxos de Dados

#### Fluxo 1: Registro de Despesa
1. **Frontend**: UsuÃ¡rio preenche formulÃ¡rio e anexa NF
2. **Edge Function**: IA (Gemini) extrai dados da NF
3. **Frontend**: Chama `INSERT` em `itens_reembolso`
4. **RLS**: Valida `igreja_id` e role (tesoureiro/admin)
5. **Postgres**: Grava fato gerador
6. **Frontend**: Exibe confirmaÃ§Ã£o

#### Fluxo 2: Pagamento e ConciliaÃ§Ã£o
1. **Frontend**: Tesoureiro aprova e escolhe forma de pagamento
2. **Frontend**: Chama `INSERT` em `transacoes_financeiras`
3. **RLS**: Valida permissÃµes
4. **Postgres**: Grava transaÃ§Ã£o com status "Pendente"
5. **Backend**: Job agenda pagamento (se integrado com banco)
6. **Banco**: Processa pagamento e retorna extrato
7. **Frontend/RPC**: Chama `reconciliar_transacoes`
8. **Postgres**: Atualiza status para "Pago" e marca como conciliado

#### Fluxo 3: GeraÃ§Ã£o do DRE
1. **Frontend**: UsuÃ¡rio acessa painel de DRE
2. **Frontend**: Chama `SELECT` em `view_dre_anual`
3. **RLS**: View herda polÃ­ticas das tabelas base
4. **Postgres**: Executa query que cruza `itens_reembolso` + `transacoes_financeiras`
5. **Frontend**: Renderiza DRE formatado

### Processamento de Notas Fiscais (IA)

**Edge Function**: `process-invoice`
- **Trigger**: Upload de arquivo em bucket `transaction-attachments`
- **Processamento**:
  1. LÃª imagem/PDF do Storage
  2. Envia para Gemini 2.5 Pro com prompt estruturado
  3. Extrai: fornecedor, valor, categoria sugerida, data
  4. Retorna JSON ao frontend
- **Acesso**: FunÃ§Ã£o autenticada (valida JWT do usuÃ¡rio)

### Relacionamento com Modelo de Dados

Tabelas principais do mÃ³dulo financeiro (conforme [`database-er-diagram.md`](../database-er-diagram.md)):

- `contas`: Contas bancÃ¡rias/caixa
- `transacoes_financeiras`: MovimentaÃ§Ãµes de caixa (foreign key para `contas`)
- `categorias_financeiras`: ClassificaÃ§Ã£o contÃ¡bil (com seÃ§Ã£o DRE)
- `subcategorias_financeiras`: Detalhamento de categorias
- `fornecedores`: Cadastro de fornecedores/recebedores
- `formas_pagamento`: Formas de pagamento configurÃ¡veis
- `centros_custo`: ClassificaÃ§Ã£o por departamento
- `bases_ministeriais`: SegmentaÃ§Ã£o por unidade ministerial

**Relacionamentos**:
- `transacoes_financeiras` â†’ `contas` (1:N)
- `transacoes_financeiras` â†’ `categorias_financeiras` (N:1)
- `transacoes_financeiras` â†’ `fornecedores` (N:1)
- `itens_reembolso` â†’ `transacoes_financeiras` (1:N) â€” um fato pode ter mÃºltiplos pagamentos

### SeguranÃ§a e Auditoria

#### RLS por Igreja
Todas as queries financeiras sÃ£o filtradas por `igreja_id` automaticamente:
- Impede acesso cruzado entre igrejas
- NÃ£o requer lÃ³gica adicional no frontend
- AuditÃ¡vel via logs do Supabase

#### Estornos e Justificativas
- Estornos sempre gravam log em tabela `audit_log`
- Frontend forÃ§a campo de justificativa (required)
- Apenas admin pode estornar lanÃ§amentos de outros tesoureiros

#### PermissÃµes Granulares
Via `user_app_roles` e `module_permissions`:
- Tesoureiro A pode ter acesso apenas Ã  base ministerial "Sede"
- Tesoureiro B pode ter acesso apenas Ã  base "Filial"

### Performance e Escalabilidade

#### Ãndices
- `transacoes_financeiras(igreja_id, data_pagamento)`
- `itens_reembolso(igreja_id, data_competencia)`
- `categorias_financeiras(secao_dre)`

#### Views Materializadas (se necessÃ¡rio)
Para igrejas com alto volume (>100k transaÃ§Ãµes/ano):
```sql
CREATE MATERIALIZED VIEW mv_dre_anual AS
SELECT ... FROM view_dre_anual;
REFRESH MATERIALIZED VIEW mv_dre_anual; -- Job noturno
```

---

## MÃ³dulo Kids (visÃ£o tÃ©cnica)

### Frontend â†’ Kids
- PÃ¡ginas em `src/pages/kids/` (Dashboard, Scanner, Config, DiretÃ³rio de CrianÃ§as, Turma Ativa) e componentes em `src/components/kids/` (ocupaÃ§Ã£o de salas, alerta de ausentes, diÃ¡logo de observaÃ§Ãµes).
- OperaÃ§Ãµes via `supabase-js` para: `kids_checkins` (check-in/checkout), `kids_diario` (diÃ¡rio/observaÃ§Ãµes) e view `view_kids_checkins_ativos` (check-ins abertos). A configuraÃ§Ã£o de responsÃ¡veis autorizados ocorre em `familias` e Ã© usada pelo app para definir o `responsavel_id` vÃ¡lido nas aÃ§Ãµes do Kids.

### PersistÃªncia (Supabase)
- Tabelas: `kids_checkins`, `kids_diario`, `familias`, `notifications`.
- Views: `view_kids_checkins_ativos` para leitura consolidada de check-ins ativos.
- Triggers/Functions: `notify_kids_diario()` (AFTER INSERT em `kids_diario`) e `notify_kids_checkout()` (AFTER UPDATE de `checkout_at` em `kids_checkins`) criam notificaÃ§Ãµes.

### SeguranÃ§a e permissÃµes (guardians)
- RLS em `kids_checkins`: lÃ­deres/admin/secretaria podem gerenciar (ALL); responsÃ¡veis podem visualizar seus prÃ³prios registros e realizar checkout enquanto `checkout_at` estiver nulo.
- AutorizaÃ§Ã£o de responsÃ¡veis Ã© modelada em `familias` (buscar pessoa â†’ confirmar parentesco â†’ selecionar crianÃ§as). O vÃ­nculo orienta o frontend a usar um `responsavel_id` consistente; o bloqueio efetivo Ã© garantido pelas polÃ­ticas RLS de `kids_checkins`/`view_kids_checkins_ativos`.

### NotificaÃ§Ãµes
- DB triggers criam linhas em `notifications` para diÃ¡rio e checkout; Supabase Realtime entrega o evento ao frontend.
- O frontend assina `notifications` (Realtime) e usa a Notifications API do navegador para exibir push; deep links levam Ã s telas do Kids.

### Diagramas relacionados
- Fluxo Kids: [`../diagramas/fluxo-kids.md`](../diagramas/fluxo-kids.md)
- SequÃªncia de NotificaÃ§Ãµes: [`../diagramas/sequencia-kids-notificacoes.md`](../diagramas/sequencia-kids-notificacoes.md)
- PermissÃµes (Guardians): [`../diagramas/permissoes-kids-guardians.md`](../diagramas/permissoes-kids-guardians.md)

### Diagramas e ReferÃªncias

- **Fluxo Completo**: [Diagrama de Fluxo Financeiro](../diagramas/fluxo-financeiro.md)
- **SequÃªncia de Eventos**: [Diagrama de SequÃªncia](../diagramas/sequencia-financeira.md)
- **ComposiÃ§Ã£o do DRE**: [Diagrama DRE](../diagramas/dre.md)
- **DecisÃ£o Arquitetural**: [ADR-001 - SeparaÃ§Ã£o Fato Gerador vs Caixa vs DRE](../adr/ADR-001-separacao-fato-gerador-caixa-dre.md)
- **Modelo de Dados**: [Database ER Diagram](../database-er-diagram.md) â€” SeÃ§Ã£o Financeiro
- **Funcionalidades**: [DocumentaÃ§Ã£o de Funcionalidades](../funcionalidades.md#2-mÃ³dulo-financeiro)
- **Manual do UsuÃ¡rio**: [Guia Financeiro](../manual-usuario.md#4-mÃ³dulo-financeiro)

---

# ğŸ‘¤ 03 â€” Guia do UsuÃ¡rio (extraÃ­do)

## `docs/03-guia-do-usuario/03-tela-pessoas.md`

```md
# Tela Pessoas

## Objetivo
Gerenciar membros, lÃ­deres e pessoas relacionadas Ã  igreja.

## Funcionalidades
- Listagem de pessoas
- Cadastro e ediÃ§Ã£o
- AssociaÃ§Ã£o a perfis
- Busca e filtros

## Fluxo do UsuÃ¡rio
```mermaid
flowchart TD
    A[Acessar Tela Pessoas] --> B[Listar Pessoas]
    B --> C[Cadastrar / Editar]
    C --> D[Salvar]



ğŸ“Œ **Este conteÃºdo foi extraÃ­do e normalizado a partir de `AVALIACAO_TELA_PESSOAS.md`.**

---

# ğŸ§¾ 04 â€” ADRs

## `docs/04-adrs/README.md`

```md
# ADRs â€” Architectural Decision Records

Registro das decisÃµes arquiteturais do sistema.
