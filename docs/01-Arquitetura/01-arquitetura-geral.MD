# Arquitetura Geral

## Vis√£o Geral
O sistema Igreja Carvalho √© uma aplica√ß√£o web constru√≠da em React,
utilizando Supabase como backend (Auth + Banco de Dados + Seguran√ßa).

### Fluxo macro do sistema
Este diagrama mostra o caminho de uma requisi√ß√£o autenticada: frontend aciona Supabase Auth, o Postgres aplica RLS e retorna dados filtrados. Refer√™ncias: [`../adr/ADR-002-autenticacao-supabase.md`](../adr/ADR-002-autenticacao-supabase.md) e [`../adr/ADR-003-rls-e-modelo-permissoes.md`](../adr/ADR-003-rls-e-modelo-permissoes.md).

```mermaid
flowchart LR
    U[Usu√°rio] -->|Browser| FE[Frontend (React + Vite)]
    FE -->|Credenciais| AUTH[Supabase Auth]
    FE -->|Queries| PG[Postgres]
    PG -->|Enforce| RLS[Row Level Security]
    RLS --> FE
```

## Componentes
- Frontend: React + Vite + Tailwind
- Backend: Supabase (Postgres + Auth)
- Seguran√ßa: Row Level Security (RLS)

## Diagrama
Vis√£o resumida do caminho request ‚Üí auth ‚Üí dados, ligada ao manual e funcionalidades. Refer√™ncias: [`../manual-usuario.md`](../manual-usuario.md) e [`../funcionalidades.md`](../funcionalidades.md).
```mermaid
flowchart LR
    User[Usu√°rio] -->|Browser| Frontend[React + Vite]
    Frontend -->|Login| Auth[Supabase Auth]
    Frontend -->|Queries| DB[(Postgres)]
    DB -->|RLS| Policies[Pol√≠ticas de Seguran√ßa]



---

# üîê Autentica√ß√£o

## `docs/01-arquitetura/04-autenticacao.md`

```md
# Autentica√ß√£o

O sistema utiliza Supabase Auth para controle de usu√°rios e sess√µes.

## Fluxo
```mermaid
sequenceDiagram
    User->>Frontend: Login
    Frontend->>SupabaseAuth: Credenciais
    SupabaseAuth-->>Frontend: JWT
    Frontend->>DB: Requests autenticadas



---

# üîê Autentica√ß√£o

## `docs/01-arquitetura/04-autenticacao.md`

```md
# Autentica√ß√£o

O sistema utiliza Supabase Auth para controle de usu√°rios e sess√µes.

## Fluxo
```mermaid
sequenceDiagram
    User->>Frontend: Login
    Frontend->>SupabaseAuth: Credenciais
    SupabaseAuth-->>Frontend: JWT
    Frontend->>DB: Requests autenticadas



---

# üóÑÔ∏è 02 ‚Äî Backend (Supabase)

## `docs/02-backend-supabase/01-modelo-de-dados.md`

```md
# Modelo de Dados

O Supabase utiliza PostgreSQL como banco relacional.

## Entidades principais
- users (auth)
- pessoas
- perfis
- relacionamentos ministeriais

## Modelo Relacional
```mermaid
erDiagram
    USERS ||--o{ PESSOAS : possui
    PESSOAS ||--o{ PERFIS : assume



## `docs/02-backend-supabase/03-rls-politicas.md`

```md
# Pol√≠ticas de Seguran√ßa (RLS)

O acesso aos dados √© controlado por Row Level Security.

## Exemplo
- Usu√°rio s√≥ visualiza dados da sua igreja
- Perfis definem permiss√µes de escrita

## Fluxo
```mermaid
flowchart LR
    Request --> Auth
    Auth --> Role
    Role --> RLS
    RLS --> DB


## Vis√£o de Autentica√ß√£o (Supabase Auth)

- Usu√°rios e sess√µes gerenciados via Supabase Auth (JWT).
- Frontend usa `supabase-js` e persiste sess√£o no `localStorage`.
- Papel/base (admin, tecnico, lider, membro) mapeado em `user_roles` e usado pelo RLS.

### Sequ√™ncia de autentica√ß√£o e uso do JWT
Diagrama resume login, refresh de sess√£o e uso do JWT nas queries. Refer√™ncias: [`02-autenticacao-supabase.MD`](02-autenticacao-supabase.MD) e [`../adr/ADR-002-autenticacao-supabase.md`](../adr/ADR-002-autenticacao-supabase.md).

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant SupabaseAuth as Supabase Auth
    participant DB

    User->>Frontend: Login (senha/magic link)
    Frontend->>SupabaseAuth: Credenciais
    SupabaseAuth-->>Frontend: JWT + refresh token
    Frontend->>DB: Query com JWT
    DB-->>Frontend: Dados filtrados por RLS
    Frontend->>SupabaseAuth: Refresh token (antes de expirar)
    SupabaseAuth-->>Frontend: Novo JWT
    Frontend->>DB: Novas queries com JWT renovado
```

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant SupabaseAuth as Supabase Auth
    participant DB

    User->>Frontend: Cria sess√£o (login/signup)
    Frontend->>SupabaseAuth: Credenciais / Magic Link
    SupabaseAuth-->>Frontend: JWT + refresh token
    Frontend->>DB: Chamada autenticada (JWT)
    DB-->>Frontend: Dados filtrados por RLS
```

## Vis√£o de Fluxo de Dados (Frontend ‚Üí Supabase ‚Üí RLS ‚Üí DB)

Fluxo detalha a valida√ß√£o de sess√£o pelo client Supabase, checagem de claims para RLS e retorno filtrado. Refer√™ncias: [`03-fluxo-de-dados.MD`](03-fluxo-de-dados.MD) e [`../adr/ADR-003-rls-e-modelo-permissoes.md`](../adr/ADR-003-rls-e-modelo-permissoes.md).

```mermaid
flowchart TD
    FE[Frontend (supabase-js)] -->|Query/RPC/Storage| EDGE[Supabase Edge/PostgREST]
    EDGE -->|Valida JWT + session| AUTH[Supabase Auth]
    EDGE -->|Claims (sub, role, igreja)| RLS[RLS Policies]
    RLS --> PG[(Postgres)]
    PG --> FE
```

```mermaid
flowchart TD
    U[Usu√°rio] --> FE[Frontend React]
    FE -->|RPC/SQL/Storage| SB[Supabase Edge/API]
    SB -->|JWT claims| RLS[RLS Policies]
    RLS --> PG[(Postgres)]
    PG --> FE

    subgraph AuthZ
    RLS
    end
```

## Refer√™ncias e Diagramas
- Diagramas relacionados: [`../diagramas/`](../diagramas/)
- Detalhe de autentica√ß√£o: [`02-autenticacao-supabase.MD`](02-autenticacao-supabase.MD)
- Fluxo de dados detalhado: [`03-fluxo-de-dados.MD`](03-fluxo-de-dados.MD)
- RLS e seguran√ßa: [`04-rls-e-seguranca.MD`](04-rls-e-seguranca.MD)

---

## M√≥dulo Financeiro (Vis√£o T√©cnica)

### Objetivo
Prover controle financeiro com separa√ß√£o clara entre **Fato Gerador** (compet√™ncia), **Fluxo de Caixa** (pagamentos) e **DRE** (resultado cont√°bil), garantindo relat√≥rios precisos e audit√°veis.

---

## M√≥dulo Pessoas / Membros (vis√£o t√©cnica)

### Como o frontend carrega e persiste dados

### Intera√ß√£o com Supabase

### Considera√ß√µes de RLS / permiss√µes / multi-tenant

### Diagramas relacionados
O m√≥dulo financeiro utiliza uma arquitetura de tr√™s camadas, conforme documentado no [ADR-001](../adr/ADR-001-separacao-fato-gerador-caixa-dre.md):

#### 1. Camada de Compet√™ncia (Fato Gerador)
- **Tabelas**: `itens_reembolso`, `categorias_financeiras`, `fornecedores`
- **Fun√ß√£o**: Registrar a natureza e o momento da decis√£o de gastar/receber
- **Acesso**: Controlado por RLS (apenas dados da pr√≥pria igreja)
- **Opera√ß√µes no Frontend**:
  - `INSERT`: Registrar novo fato gerador (categoria, fornecedor, valor)
  - `UPDATE`: Reclassificar categoria ou ajustar compet√™ncia

---

## M√≥dulo Jornadas e Ensino (vis√£o t√©cnica)

- Frontend: p√°ginas `src/pages/Ensino.tsx` e `src/pages/ensino/DetalhesJornada.tsx`, componentes de aula/sala/check-in em `src/components/ensino/`.
- Dados principais (Supabase): jornadas, etapas, inscri√ß√µes, aulas, salas e presen√ßas de aula (ver ERD), com bloqueio de player quando `status_pagamento = 'pendente'` nas inscri√ß√µes.
- Fluxos:
  - Admin cria/edita jornada e etapas; matricula alunos; agenda aulas com sala e professor.
  - Aluno/visitante se inscreve; player l√™ progresso e etapas; presen√ßas gravadas na aula.
  - Cursos pagos: cria√ß√£o de transa√ß√£o financeira de entrada e v√≠nculo na inscri√ß√£o (status pendente at√© baixa).
- Seguran√ßa: RLS aplicado via Supabase; consultas via `supabase-js`; sem Edge Function dedicada ao m√≥dulo no momento (a confirmar).
  - `DELETE`: Estornar fato gerador (requer justificativa)

#### 2. Camada de Caixa (Transa√ß√µes)
- **Tabelas**: `transacoes_financeiras`, `contas`, `formas_pagamento`
- **Fun√ß√£o**: Registrar quando e como o dinheiro efetivamente movimentou
- **Acesso**: RLS filtra por `igreja_id` e role (tesoureiro/admin)
- **Opera√ß√µes no Frontend**:
  - `INSERT`: Criar transa√ß√£o de pagamento/recebimento
  - `UPDATE`: Confirmar pagamento, adicionar juros/multas/descontos
  - `DELETE`: Estornar pagamento (requer justificativa)

#### 3. Camada de Intelig√™ncia (DRE e Relat√≥rios)
- **Views**: `view_contabil_unificada`, `view_dre_anual`
- **Fun√ß√£o**: Cruzar compet√™ncia + caixa para gerar relat√≥rios
- **Acesso**: RLS autom√°tico via views (herdam pol√≠ticas das tabelas base)
- **Opera√ß√µes no Frontend**:
  - `SELECT`: Consultar DRE, proje√ß√µes, reconcilia√ß√£o
  - **Nenhuma escrita**: Views s√£o read-only

### Integra√ß√£o com Supabase

#### Row Level Security (RLS)
Todas as tabelas financeiras aplicam RLS para garantir isolamento multi-igreja:

```sql
-- Exemplo de pol√≠tica (pseudo-c√≥digo)
CREATE POLICY select_own_church ON transacoes_financeiras
FOR SELECT
USING (
  igreja_id = current_setting('request.jwt.claim.igreja_id')::uuid
);

CREATE POLICY insert_treasurer_only ON transacoes_financeiras
FOR INSERT
WITH CHECK (
  igreja_id = current_setting('request.jwt.claim.igreja_id')::uuid
  AND current_setting('request.jwt.claim.role') IN ('admin', 'tesoureiro')
);
```

**Pap√©is e Permiss√µes**:
- `admin`: Acesso completo (CRUD em todas as camadas)
- `tesoureiro`: CRUD em transa√ß√µes e fatos geradores; leitura em relat√≥rios
- `lider`: Leitura em relat√≥rios de sua base ministerial
- `membro`: Sem acesso ao m√≥dulo financeiro (a menos que explicitamente autorizado)

#### Queries e RPCs
O frontend executa queries via Supabase Client (`@supabase/supabase-js`):

**Criar Fato Gerador**:
```typescript
const { data, error } = await supabase
  .from('itens_reembolso')
  .insert({
    categoria_id: categoriaId,
    fornecedor_id: fornecedorId,
    valor_original: 500.00,
    data_competencia: '2024-12-01',
    igreja_id: currentUser.igreja_id
  });
```

**Confirmar Pagamento**:
```typescript
const { data, error } = await supabase
  .from('transacoes_financeiras')
  .update({
    status: 'Pago',
    data_pagamento: '2024-12-10',
    juros: 0,
    descontos: 0
  })
  .eq('id', transacaoId);
```

**Consultar DRE (via View)**:
```typescript
const { data, error } = await supabase
  .from('view_dre_anual')
  .select('*')
  .eq('ano', 2024)
  .order('categoria');
```

**RPC para Reconcilia√ß√£o Banc√°ria**:
```typescript
const { data, error } = await supabase
  .rpc('reconciliar_transacoes', {
    conta_id: contaId,
    extrato: [...] // Array de lan√ßamentos do banco
  });
```

### Fluxos de Dados

#### Fluxo 1: Registro de Despesa
1. **Frontend**: Usu√°rio preenche formul√°rio e anexa NF
2. **Edge Function**: IA (Gemini) extrai dados da NF
3. **Frontend**: Chama `INSERT` em `itens_reembolso`
4. **RLS**: Valida `igreja_id` e role (tesoureiro/admin)
5. **Postgres**: Grava fato gerador
6. **Frontend**: Exibe confirma√ß√£o

#### Fluxo 2: Pagamento e Concilia√ß√£o
1. **Frontend**: Tesoureiro aprova e escolhe forma de pagamento
2. **Frontend**: Chama `INSERT` em `transacoes_financeiras`
3. **RLS**: Valida permiss√µes
4. **Postgres**: Grava transa√ß√£o com status "Pendente"
5. **Backend**: Job agenda pagamento (se integrado com banco)
6. **Banco**: Processa pagamento e retorna extrato
7. **Frontend/RPC**: Chama `reconciliar_transacoes`
8. **Postgres**: Atualiza status para "Pago" e marca como conciliado

#### Fluxo 3: Gera√ß√£o do DRE
1. **Frontend**: Usu√°rio acessa painel de DRE
2. **Frontend**: Chama `SELECT` em `view_dre_anual`
3. **RLS**: View herda pol√≠ticas das tabelas base
4. **Postgres**: Executa query que cruza `itens_reembolso` + `transacoes_financeiras`
5. **Frontend**: Renderiza DRE formatado

### Processamento de Notas Fiscais (IA)

**Edge Function**: `process-invoice`
- **Trigger**: Upload de arquivo em bucket `transaction-attachments`
- **Processamento**:
  1. L√™ imagem/PDF do Storage
  2. Envia para Gemini 2.5 Pro com prompt estruturado
  3. Extrai: fornecedor, valor, categoria sugerida, data
  4. Retorna JSON ao frontend
- **Acesso**: Fun√ß√£o autenticada (valida JWT do usu√°rio)

### Relacionamento com Modelo de Dados

Tabelas principais do m√≥dulo financeiro (conforme [`database-er-diagram.md`](../database-er-diagram.md)):

- `contas`: Contas banc√°rias/caixa
- `transacoes_financeiras`: Movimenta√ß√µes de caixa (foreign key para `contas`)
- `categorias_financeiras`: Classifica√ß√£o cont√°bil (com se√ß√£o DRE)
- `subcategorias_financeiras`: Detalhamento de categorias
- `fornecedores`: Cadastro de fornecedores/recebedores
- `formas_pagamento`: Formas de pagamento configur√°veis
- `centros_custo`: Classifica√ß√£o por departamento
- `bases_ministeriais`: Segmenta√ß√£o por unidade ministerial

**Relacionamentos**:
- `transacoes_financeiras` ‚Üí `contas` (1:N)
- `transacoes_financeiras` ‚Üí `categorias_financeiras` (N:1)
- `transacoes_financeiras` ‚Üí `fornecedores` (N:1)
- `itens_reembolso` ‚Üí `transacoes_financeiras` (1:N) ‚Äî um fato pode ter m√∫ltiplos pagamentos

### Seguran√ßa e Auditoria

#### RLS por Igreja
Todas as queries financeiras s√£o filtradas por `igreja_id` automaticamente:
- Impede acesso cruzado entre igrejas
- N√£o requer l√≥gica adicional no frontend
- Audit√°vel via logs do Supabase

#### Estornos e Justificativas
- Estornos sempre gravam log em tabela `audit_log`
- Frontend for√ßa campo de justificativa (required)
- Apenas admin pode estornar lan√ßamentos de outros tesoureiros

#### Permiss√µes Granulares
Via `user_app_roles` e `module_permissions`:
- Tesoureiro A pode ter acesso apenas √† base ministerial "Sede"
- Tesoureiro B pode ter acesso apenas √† base "Filial"

### Performance e Escalabilidade

#### √çndices
- `transacoes_financeiras(igreja_id, data_pagamento)`
- `itens_reembolso(igreja_id, data_competencia)`
- `categorias_financeiras(secao_dre)`

#### Views Materializadas (se necess√°rio)
Para igrejas com alto volume (>100k transa√ß√µes/ano):
```sql
CREATE MATERIALIZED VIEW mv_dre_anual AS
SELECT ... FROM view_dre_anual;
REFRESH MATERIALIZED VIEW mv_dre_anual; -- Job noturno
```

---

## M√≥dulo Kids (vis√£o t√©cnica)

### Frontend ‚Üí Kids
- P√°ginas em `src/pages/kids/` (Dashboard, Scanner, Config, Diret√≥rio de Crian√ßas, Turma Ativa) e componentes em `src/components/kids/` (ocupa√ß√£o de salas, alerta de ausentes, di√°logo de observa√ß√µes).
- Opera√ß√µes via `supabase-js` para: `kids_checkins` (check-in/checkout), `kids_diario` (di√°rio/observa√ß√µes) e view `view_kids_checkins_ativos` (check-ins abertos). A configura√ß√£o de respons√°veis autorizados ocorre em `familias` e √© usada pelo app para definir o `responsavel_id` v√°lido nas a√ß√µes do Kids.

### Persist√™ncia (Supabase)
- Tabelas: `kids_checkins`, `kids_diario`, `familias`, `notifications`.
- Views: `view_kids_checkins_ativos` para leitura consolidada de check-ins ativos.
- Triggers/Functions: `notify_kids_diario()` (AFTER INSERT em `kids_diario`) e `notify_kids_checkout()` (AFTER UPDATE de `checkout_at` em `kids_checkins`) criam notifica√ß√µes.

### Seguran√ßa e permiss√µes (guardians)
- RLS em `kids_checkins`: l√≠deres/admin/secretaria podem gerenciar (ALL); respons√°veis podem visualizar seus pr√≥prios registros e realizar checkout enquanto `checkout_at` estiver nulo.
- Autoriza√ß√£o de respons√°veis √© modelada em `familias` (buscar pessoa ‚Üí confirmar parentesco ‚Üí selecionar crian√ßas). O v√≠nculo orienta o frontend a usar um `responsavel_id` consistente; o bloqueio efetivo √© garantido pelas pol√≠ticas RLS de `kids_checkins`/`view_kids_checkins_ativos`.

### Notifica√ß√µes
- DB triggers criam linhas em `notifications` para di√°rio e checkout; Supabase Realtime entrega o evento ao frontend.
- O frontend assina `notifications` (Realtime) e usa a Notifications API do navegador para exibir push; deep links levam √†s telas do Kids.

### Diagramas relacionados
- Fluxo Kids: [`../diagramas/fluxo-kids.md`](../diagramas/fluxo-kids.md)
- Sequ√™ncia de Notifica√ß√µes: [`../diagramas/sequencia-kids-notificacoes.md`](../diagramas/sequencia-kids-notificacoes.md)
- Permiss√µes (Guardians): [`../diagramas/permissoes-kids-guardians.md`](../diagramas/permissoes-kids-guardians.md)

---

## M√≥dulo Comunica√ß√£o (vis√£o t√©cnica)

> A separa√ß√£o conceitual entre Comunica√ß√£o e Notifica√ß√µes est√° formalizada no [ADR-006 ‚Äî Separa√ß√£o entre Comunica√ß√£o e Notifica√ß√µes](../adr/ADR-006-separacao-comunicacao-notificacoes.md).

### Frontend ‚Üí Comunica√ß√£o
- P√°ginas em `src/pages/` (Comunicados, Announcements, AnnouncementsAdmin, Publicacao) e componentes em `src/components/comunicados/` (ComunicadoDialog), `src/components/publicacao/` (PublicacaoStepper) e `src/components/` (BannerCarousel para exibi√ß√£o no app).
- Opera√ß√µes via `supabase-js` para: tabela `comunicados` (INSERT/UPDATE/DELETE de comunicados) e storage bucket `comunicados` (upload de imagens/artes).
- Wizard de cria√ß√£o em 3 etapas: conte√∫do (t√≠tulo, tipo banner/alerta, descri√ß√£o, imagem), canais (flags `exibir_app`, `exibir_telao`, `exibir_site`), agendamento (`data_inicio`, `data_fim`, tags, categoria, FK opcional para `culto_id` e `midia_id`).

### Persist√™ncia (Supabase)
- Tabela: `comunicados` com campos de conte√∫do, flags de canal, datas de per√≠odo, categoriza√ß√£o e vincula√ß√£o opcional.
- Storage bucket: `comunicados` (p√∫blico para leitura, upload restrito a autenticados).
- Trigger: `update_comunicados_updated_at` (BEFORE UPDATE) atualiza `updated_at` automaticamente.

### Publica√ß√£o e exibi√ß√£o
- **Publica√ß√£o instant√¢nea**: comunicados s√£o inseridos com `ativo = true` (ou `false` se desativado); n√£o h√° workflow de aprova√ß√£o, filas ou workers. A publica√ß√£o √© s√≠ncrona: INSERT ‚Üí comunicado vis√≠vel imediatamente nos canais selecionados.
- **Exibi√ß√£o por canal**:
  - **App/Dashboard** (`exibir_app = true`): membros visualizam via carrossel `BannerCarousel.tsx`; query filtra por `ativo = true`, `data_inicio <= NOW()`, `data_fim IS NULL OR >= NOW()`.
  - **Tel√£o/Projetor** (`exibir_telao = true`): operador acessa `/telao` (`Telao.tsx`); carrossel autom√°tico com ordem por `ordem_telao`; suporta arte alternativa via `url_arquivo_telao`.
  - **Site P√∫blico** (`exibir_site = true`): integra√ß√£o com carrossel do site (a confirmar).
- **Expira√ß√£o passiva**: comunicados com `data_fim` passada s√£o filtrados automaticamente nas queries de visualiza√ß√£o; n√£o h√° job/cron para desativar registros.

### Mecanismo de entrega
- **N√£o h√° triggers de notifica√ß√£o**: este m√≥dulo n√£o dispara notifica√ß√µes push, e-mails ou mensagens WhatsApp. Comunicados s√£o conte√∫do editorial est√°tico consumido por queries s√≠ncronas.
- **Sem edge functions ou workers**: toda l√≥gica √© client-side (valida√ß√£o, upload, persist√™ncia) ou server-side (RLS, trigger de `updated_at`).
- **Leitura em tempo real** (a confirmar): poss√≠vel uso de Supabase Realtime para atualizar carross√©is automaticamente quando novos comunicados s√£o publicados, mas n√£o confirmado no c√≥digo atual.

### Seguran√ßa e permiss√µes (RLS)
- **Policy `comunicados_leitura_publica`** (SELECT):
  - Escopo: qualquer usu√°rio (incluindo n√£o autenticados)
  - Condi√ß√£o: `ativo = true` e per√≠odo v√°lido (`data_inicio <= NOW()` e `data_fim IS NULL OR >= NOW()`)
  - Prop√≥sito: permitir visualiza√ß√£o p√∫blica de comunicados ativos no app, tel√£o e site
- **Policy `comunicados_gestao_admin`** (ALL):
  - Escopo: apenas usu√°rios autenticados (`auth.role() = 'authenticated'`)
  - Refinamento: aplica√ß√£o valida roles admin/secretario via `has_role()` antes de exibir UI de cria√ß√£o/edi√ß√£o
  - Prop√≥sito: restringir CRUD de comunicados √† lideran√ßa
- **Storage bucket `comunicados`**:
  - SELECT: p√∫blico (policy `comunicados_public_access`)
  - INSERT/UPDATE/DELETE: apenas autenticados (policies `comunicados_admin_insert/update/delete`)
- **Sem segmenta√ß√£o por perfil**: todos os usu√°rios autenticados veem os mesmos comunicados ativos por canal; n√£o h√° filtros por role, grupo ou pessoa espec√≠fica.

### Considera√ß√µes arquiteturais
- **Modelo editorial**: comunicados s√£o criados manualmente pela lideran√ßa, n√£o h√° automa√ß√£o de conte√∫do ou templates din√¢micos.
- **Multiplataforma**: um comunicado pode ser publicado simultaneamente em app, tel√£o e site (flags independentes).
- **Sem analytics**: n√£o h√° rastreamento de visualiza√ß√µes, cliques ou engajamento (a confirmar).
- **V√≠nculo opcional com eventos**: FK `culto_id` permite associar comunicado a culto espec√≠fico, mas n√£o √© obrigat√≥rio.
- **Reutiliza√ß√£o de m√≠dias**: FK `midia_id` permite vincular comunicado √† biblioteca de m√≠dias existente.

### Diagramas relacionados
- Fluxo Comunica√ß√£o: [`../diagramas/fluxo-comunicacao.md`](../diagramas/fluxo-comunicacao.md)
- Sequ√™ncia Comunica√ß√£o: [`../diagramas/sequencia-comunicacao.md`](../diagramas/sequencia-comunicacao.md)

---

## M√≥dulo Notifica√ß√µes (vis√£o t√©cnica)

### Frontend ‚Üí Notifica√ß√µes
- Hook central: `src/hooks/useNotifications.tsx` ‚Äî gerencia estado local de notifica√ß√µes, subscri√ß√£o Realtime, a√ß√µes de leitura/exclus√£o e permiss√µes de push.
- Componentes:
  - `src/components/NotificationBell.tsx`: sininho na barra superior, popover com lista de notifica√ß√µes, deep linking por tipo de evento, a√ß√µes de leitura/exclus√£o.
  - `src/components/NotificationSettings.tsx`: configura√ß√µes de prefer√™ncias do usu√°rio (a confirmar).
  - `src/pages/admin/Notificacoes.tsx`: interface de administra√ß√£o para gerenciar eventos e regras de disparo (quem recebe, por qual canal).
- Opera√ß√µes via `supabase-js`:
  - **Leitura**: SELECT em `notifications` (WHERE `user_id = auth.uid()`) e `notificacao_eventos` / `notificacao_regras` (para admin).
  - **Atualiza√ß√£o**: UPDATE `read = true` ao clicar em notifica√ß√£o ou "Limpar".
  - **Exclus√£o**: DELETE em `notifications` ao clicar na lixeira.
  - **Admin CRUD**: INSERT/UPDATE/DELETE em `notificacao_regras` para adicionar/remover destinat√°rios e alternar canais.
- **Realtime Subscription**: hook subscreve canal `notifications:user_id=eq.{uid}` via WebSocket; ao receber evento INSERT, atualiza estado local imediatamente.
- **Browser Push**: se permiss√£o concedida (`Notification.permission === 'granted'`), dispara `new Notification(title, body)` ao receber notifica√ß√£o via Realtime.

### Persist√™ncia (Supabase)
- **Tabela `notifications`** (database-schema.sql):
  - Campos: `id`, `user_id`, `title`, `message`, `type`, `read` (boolean), `related_user_id`, `metadata` (jsonb), `created_at`.
  - √çndice impl√≠cito em `user_id` (para queries por usu√°rio).
  - Sem soft delete (DELETE f√≠sico ao excluir).
- **Tabela `notificacao_eventos`** (migration 20251211170047):
  - Cat√°logo de eventos do sistema: `slug` (PK), `nome`, `descricao`, `categoria`, `provider_preferencial` (meta_direto/make), `variaveis` (array de placeholders), `template_meta` (texto com `{{chave}}` para substitui√ß√£o).
  - Exemplos: `financeiro_conta_vencer`, `kids_checkin`, `novo_visitante`, `pedido_oracao`.
- **Tabela `notificacao_regras`** (migration 20251211170047):
  - Regras de disparo: `id` (PK), `evento_slug` (FK), `role_alvo` (app_role), `user_id_especifico` (UUID opcional), `canais` (jsonb: `{inapp, push, whatsapp}`), `ativo` (boolean).
  - Uma regra define: para qual evento, quem recebe (cargo ou pessoa espec√≠fica), por quais canais.

### Disparo e Entrega
- **Edge Function `disparar-alerta`** (supabase/functions/disparar-alerta/index.ts):
  - Entrada: `{evento: string, dados: Record<string, any>, user_id_alvo?: string}`
  - Fluxo:
    1. Busca evento em `notificacao_eventos` (valida se slug existe).
    2. Busca regras ativas em `notificacao_regras` WHERE `evento_slug = evento` AND `ativo = true`.
    3. Resolve destinat√°rios: se `role_alvo`, busca usu√°rios com esse cargo em `user_roles`; se `user_id_especifico`, apenas esse usu√°rio.
    4. Para cada destinat√°rio, busca dados em `profiles` (nome, telefone, email).
    5. Formata template substituindo `{{chave}}` por valores em `dados` (ex: `{{crianca}}` ‚Üí "Jo√£o Silva").
    6. Para cada canal ativo na regra:
       - **In-App**: INSERT em `notifications` (user_id, title, message, type, metadata).
       - **Push**: frontend detecta via Realtime e dispara Browser Notification API.
       - **WhatsApp**: POST para Meta API (se `provider_preferencial = 'meta_direto'`) ou Make webhook (se `'make'`).
  - **S√≠ncrono**: fun√ß√£o retorna ap√≥s processar todos destinat√°rios; n√£o h√° fila ou worker ass√≠ncrono.
- **Edge Functions auxiliares** (cron jobs):
  - `notificar-aniversarios`: executa diariamente (via cron ou scheduler), verifica anivers√°rios do dia seguinte e invoca `disparar-alerta` com evento correspondente.
  - `notificar-sentimentos-diario`: dispara notifica√ß√£o perguntando sobre sentimentos di√°rios.
  - `notificar-liturgia-make`: envia notifica√ß√£o de liturgia via Make.
- **Entrega Imediata**: notifica√ß√µes s√£o criadas e entregues no momento do evento; n√£o h√° agendamento ou delay.

### Mecanismo de Atualiza√ß√£o em Tempo Real
- **Supabase Realtime**: ao INSERT em `notifications`, evento √© propagado via WebSocket para todos clientes subscritos ao canal `notifications:user_id=eq.{uid}`.
- **Frontend Hook**: `useNotifications` recebe evento, adiciona notifica√ß√£o ao estado local, incrementa `unreadCount`, atualiza badge do sininho.
- **Optimistic Update**: ao marcar como lida ou excluir, frontend atualiza estado local antes de confirmar UPDATE/DELETE (melhor UX).
- **Push Notification**: se permiss√£o ativa, `useNotifications` dispara `new Notification()` ao receber notifica√ß√£o via Realtime; usu√°rio v√™ alerta no navegador mesmo com aba fechada.

### Seguran√ßa e Permiss√µes (RLS)
- **Tabela `notifications`**:
  - **Criar** (`"Sistema pode criar notifica√ß√µes"`): INSERT sem restri√ß√£o (service role pode criar para qualquer usu√°rio).
  - **Ler** (`"Usu√°rios podem ver suas notifica√ß√µes"`): SELECT WHERE `auth.uid() = user_id`.
  - **Atualizar** (`"Usu√°rios podem atualizar suas notifica√ß√µes"`): UPDATE WHERE `auth.uid() = user_id`.
  - **Sem DELETE policy expl√≠cita** (a confirmar: provavelmente DELETE restrito via aplica√ß√£o ou policy `auth.uid() = user_id`).
- **Tabelas `notificacao_eventos` e `notificacao_regras`**:
  - **Leitura p√∫blica** (authenticated): SELECT para todos usu√°rios autenticados (necess√°rio para sistema resolver regras).
  - **Admin gerencia regras**: ALL (INSERT/UPDATE/DELETE) apenas para usu√°rios com `role = 'admin'` em `user_roles`.
- **Sem exposi√ß√£o p√∫blica**: notifica√ß√µes s√£o estritamente privadas por usu√°rio; n√£o h√° endpoint p√∫blico ou exibi√ß√£o externa.

### Considera√ß√µes Arquiteturais
- **Modelo push baseado em eventos**: notifica√ß√µes s√£o rea√ß√µes autom√°ticas a eventos do sistema, n√£o cria√ß√£o manual.
- **Templates fixos**: conte√∫do √© gerado por template do evento, sem edi√ß√£o manual pelo usu√°rio.
- **Multi-canal configur√°vel**: admin pode ativar/desativar canais (in-app, push, WhatsApp) por evento e destinat√°rio.
- **Provider Plug√°vel**: arquitetura permite trocar provider de WhatsApp (Meta direto vs Make) via flag `provider_preferencial`.
- **Sem fila ou retry**: se entrega falhar (ex: Meta API down), notifica√ß√£o √© perdida; n√£o h√° mecanismo de reenvio (a confirmar).
- **Realtime First**: arquitetura assume conex√£o WebSocket ativa; se desconectado, notifica√ß√µes in-app s√≥ aparecem ap√≥s reload.
- **Sem analytics**: n√£o h√° rastreamento de taxa de abertura, clique ou engajamento (a confirmar).
- **Deep Linking**: cada tipo de notifica√ß√£o tem rota mapeada no `NotificationBell` (ex: `kids_checkin` ‚Üí `/kids/dashboard`).

### Integra√ß√µes Externas
- **Meta Business API** (WhatsApp):
  - Autentica√ß√£o via token bearer.
  - POST para envio de mensagem template.
  - Provider: `meta_direto`.
- **Make/n8n Webhook** (WhatsApp):
  - POST HTTP para workflow externo.
  - Workflow processa e envia via WhatsApp Business API.
  - Provider: `make`.
- **Browser Notification API**:
  - Requer permiss√£o do usu√°rio (`Notification.requestPermission()`).
  - Suporta √≠cone, badge, requireInteraction, data payload.
  - Deep linking ao clicar na notifica√ß√£o.

### Diagramas relacionados
- Fluxo Notifica√ß√µes: [`../diagramas/fluxo-notificacoes.md`](../diagramas/fluxo-notificacoes.md)
- Sequ√™ncia Notifica√ß√µes: [`../diagramas/sequencia-notificacoes.md`](../diagramas/sequencia-notificacoes.md)

### Diagramas e Refer√™ncias

- **Fluxo Completo**: [Diagrama de Fluxo Financeiro](../diagramas/fluxo-financeiro.md)
- **Sequ√™ncia de Eventos**: [Diagrama de Sequ√™ncia](../diagramas/sequencia-financeira.md)
- **Composi√ß√£o do DRE**: [Diagrama DRE](../diagramas/dre.md)
- **Decis√£o Arquitetural**: [ADR-001 - Separa√ß√£o Fato Gerador vs Caixa vs DRE](../adr/ADR-001-separacao-fato-gerador-caixa-dre.md)
- **Modelo de Dados**: [Database ER Diagram](../database-er-diagram.md) ‚Äî Se√ß√£o Financeiro
- **Funcionalidades**: [Documenta√ß√£o de Funcionalidades](../funcionalidades.md#2-m√≥dulo-financeiro)
- **Manual do Usu√°rio**: [Guia Financeiro](../manual-usuario.md#4-m√≥dulo-financeiro)

---

# üë§ 03 ‚Äî Guia do Usu√°rio (extra√≠do)

## `docs/03-guia-do-usuario/03-tela-pessoas.md`

```md
# Tela Pessoas

## Objetivo
Gerenciar membros, l√≠deres e pessoas relacionadas √† igreja.

## Funcionalidades
- Listagem de pessoas
- Cadastro e edi√ß√£o
- Associa√ß√£o a perfis
- Busca e filtros

## Fluxo do Usu√°rio
```mermaid
flowchart TD
    A[Acessar Tela Pessoas] --> B[Listar Pessoas]
    B --> C[Cadastrar / Editar]
    C --> D[Salvar]



üìå **Este conte√∫do foi extra√≠do e normalizado a partir de `AVALIACAO_TELA_PESSOAS.md`.**

---

# üßæ 04 ‚Äî ADRs

## `docs/04-adrs/README.md`

```md
# ADRs ‚Äî Architectural Decision Records

Registro das decis√µes arquiteturais do sistema.
